#!/usr/bin/env node
/**
 * Generates bundled .d.ts strings for react-tela modules and writes them
 * as importable TypeScript constants for the Monaco playground editor.
 *
 * Usage: node scripts/generate-playground-types.mjs
 */

import { execFileSync } from 'node:child_process';
import { readFileSync, writeFileSync } from 'node:fs';
import { resolve, dirname } from 'node:path';
import { fileURLToPath } from 'node:url';
import { tmpdir } from 'node:os';
import { join } from 'node:path';

const __dirname = dirname(fileURLToPath(import.meta.url));
const root = resolve(__dirname, '..');

const entries = [
  { entry: 'src/index.tsx', module: 'react-tela' },
  { entry: 'src/render.ts', module: 'react-tela/render' },
  { entry: 'src/flex.tsx', module: 'react-tela/flex' },
];

const results = {};

for (const { entry, module: moduleName } of entries) {
  const tmpFile = join(tmpdir(), `react-tela-${moduleName.replace(/\//g, '-')}.d.ts`);

  execFileSync(
    resolve(root, 'node_modules/.bin/dts-bundle-generator'),
    ['-o', tmpFile, '--no-check', resolve(root, entry)],
    { cwd: root, stdio: ['pipe', 'pipe', 'pipe'] },
  );

  let content = readFileSync(tmpFile, 'utf-8');

  // Strip the "Generated by" comment
  content = content.replace(/^\/\/ Generated by dts-bundle-generator.*\n\n?/, '');

  // Convert to a `declare module` block for Monaco.
  // 1. Remove top-level `import` statements (React etc.) — Monaco has its own React stub
  // 2. Remove `export {};` at the end
  // 3. Strip `export` from declarations (they're implicitly exported inside declare module)
  //    Actually keep `export` — it's valid inside declare module blocks.
  // 4. Replace `React$1` references with `React` (artifact of dts-bundle-generator)
  content = content
    .replace(/^import .*;\n/gm, '')
    .replace(/\nexport \{\};?\s*$/, '')
    .replace(/React\$1/g, 'React')
    .trim();

  // Wrap in declare module
  const wrapped = `declare module "${moduleName}" {\n  import React from "react";\n  import { PropsWithChildren, ReactNode } from "react";\n${indent(content)}\n}`;

  results[moduleName] = wrapped;
}

function indent(text) {
  return text
    .split('\n')
    .map((line) => (line ? `  ${line}` : line))
    .join('\n');
}

function varName(mod) {
  return (
    mod
      .replace(/[^a-zA-Z0-9]+/g, ' ')
      .trim()
      .split(' ')
      .map((w, i) =>
        i === 0
          ? w.toLowerCase()
          : w[0].toUpperCase() + w.slice(1).toLowerCase(),
      )
      .join('') + 'Types'
  );
}

// Build output file
const output = `// AUTO-GENERATED — do not edit manually.
// Run \`pnpm generate:types\` to regenerate from source.

${Object.entries(results)
  .map(([mod, dts]) => `export const ${varName(mod)} = ${JSON.stringify(dts)};`)
  .join('\n\n')}
`;

const outPath = resolve(root, 'playground/src/generated-types.ts');
writeFileSync(outPath, output);
console.log(`✅ Generated ${outPath}`);
